{% extends "base.html" %}
{% block title %}Run Pipeline — Wireless Intel{% endblock %}
{% block content %}
<h2>Run Pipeline</h2>

{% if running %}
  <div class="alert alert-warning">A process is already running. Refresh to check status.</div>
{% else %}
  <div class="d-flex gap-2 mb-3 flex-wrap">
    <button class="btn btn-outline-primary run-btn" data-url="/run/ingest/stream">
      ▶ Run Ingest
    </button>
    <button class="btn btn-outline-success run-btn" data-url="/run/report/stream">
      ▶ Generate Report
    </button>
    <button class="btn btn-primary run-btn" data-url="/run/stream">
      ▶ Run Both
    </button>
  </div>
{% endif %}

<pre id="log"
     class="mt-3 p-3 bg-dark text-light rounded font-monospace small"
     style="min-height: 120px; max-height: 520px; overflow-y: auto; display: none;"></pre>

<div id="statusMsg" class="mt-2 fw-semibold"></div>

<script>
document.querySelectorAll('.run-btn').forEach(function(btn) {
  btn.addEventListener('click', function() {
    var allBtns = document.querySelectorAll('.run-btn');
    allBtns.forEach(function(b) { b.disabled = true; });
    btn.textContent = '⏳ Running…';

    var log = document.getElementById('log');
    var msg = document.getElementById('statusMsg');
    log.textContent = '';
    log.style.display = 'block';
    msg.textContent = '';

    var es = new EventSource(btn.dataset.url);

    es.onmessage = function(e) {
      if (e.data === '[DONE:OK]') {
        es.close();
        msg.innerHTML = '<span class="text-success">Completed successfully.</span>';
        btn.textContent = btn.dataset.url.includes('ingest') ? '▶ Run Ingest'
                        : btn.dataset.url.includes('report') ? '▶ Generate Report'
                        : '▶ Run Both';
        allBtns.forEach(function(b) { b.disabled = false; });
        return;
      }
      if (e.data === '[DONE:FAILED]') {
        es.close();
        msg.innerHTML = '<span class="text-danger">Failed. See log above.</span>';
        btn.textContent = 'Retry';
        allBtns.forEach(function(b) { b.disabled = false; });
        return;
      }
      log.textContent += e.data + '\n';
      log.scrollTop = log.scrollHeight;
    };

    es.onerror = function() {
      es.close();
      msg.innerHTML = '<span class="text-danger">Connection lost.</span>';
      btn.textContent = 'Retry';
      allBtns.forEach(function(b) { b.disabled = false; });
    };
  });
});
</script>
{% endblock %}
