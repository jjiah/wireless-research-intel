{% extends "base.html" %}
{% block title %}Run Pipeline â€” Wireless Intel{% endblock %}
{% block content %}
<h2>Run Pipeline</h2>
<p class="text-muted">
  Runs <code>ingest_openalex.py</code> then
  <code>generate_report.py --weeks 4</code> and streams live output.
</p>

{% if running %}
  <div class="alert alert-warning">Pipeline is currently running. Try again in a moment.</div>
{% else %}
  <button id="startBtn" class="btn btn-success btn-lg" onclick="startPipeline()">
    Start Pipeline
  </button>
{% endif %}

<pre id="log"
     class="mt-3 p-3 bg-dark text-light rounded font-monospace small"
     style="min-height: 120px; max-height: 520px; overflow-y: auto; display: none;"></pre>

<div id="statusMsg" class="mt-2 fw-semibold"></div>

<script>
function startPipeline() {
  const btn = document.getElementById('startBtn');
  const log = document.getElementById('log');
  const msg = document.getElementById('statusMsg');

  btn.disabled = true;
  btn.textContent = 'Running...';
  log.style.display = 'block';
  log.textContent = '';
  msg.textContent = '';

  const es = new EventSource('/run/stream');

  es.onmessage = function(e) {
    if (e.data === '[DONE:OK]') {
      es.close();
      msg.innerHTML = '<span class="text-success">Pipeline completed successfully.</span>';
      btn.textContent = 'Run Again';
      btn.disabled = false;
      return;
    }
    if (e.data === '[DONE:FAILED]') {
      es.close();
      msg.innerHTML = '<span class="text-danger">Pipeline failed. See log above.</span>';
      btn.textContent = 'Retry';
      btn.disabled = false;
      return;
    }
    log.textContent += e.data + '\n';
    log.scrollTop = log.scrollHeight;
  };

  es.onerror = function() {
    es.close();
    msg.innerHTML = '<span class="text-danger">Connection lost.</span>';
    btn.textContent = 'Retry';
    btn.disabled = false;
  };
}
</script>
{% endblock %}
